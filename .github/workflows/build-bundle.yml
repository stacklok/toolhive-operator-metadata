name: Build and Publish Bundle Image

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to run workflow on'
        required: true
        default: 'main'

permissions:
  packages: write
  contents: read

jobs:
  build-bundle:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up dependencies
        run: |
          # Install yq for YAML processing (required by make bundle)
          sudo wget -qO /usr/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/bin/yq

          # Install operator-sdk for bundle validation
          OPERATOR_SDK_VERSION=v1.41.0
          curl -LO https://github.com/operator-framework/operator-sdk/releases/download/${OPERATOR_SDK_VERSION}/operator-sdk_linux_amd64
          sudo mv operator-sdk_linux_amd64 /usr/local/bin/operator-sdk
          sudo chmod +x /usr/local/bin/operator-sdk

      - name: Extract version from Makefile
        id: version
        run: |
          VERSION=$(grep "^BUNDLE_TAG" Makefile | cut -d'=' -f2 | tr -d ' ')
          if [ -z "$VERSION" ]; then
            echo "‚ùå ERROR: Failed to extract VERSION from Makefile"
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "‚úÖ Extracted VERSION: $VERSION"

      - name: Generate bundle manifests
        run: |
          echo "üì¶ Generating bundle manifests with 'make bundle'..."
          make bundle
          if [ $? -ne 0 ]; then
            echo "‚ùå ERROR: 'make bundle' failed"
            exit 1
          fi
          echo "‚úÖ Bundle manifests generated successfully"

      - name: Set lowercase actor name
        id: actor_lowercase
        run: echo "actor_lowercase=${GITHUB_ACTOR@L}" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ steps.actor_lowercase.outputs.actor_lowercase }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set lowercase repository name
        id: repository_lowercase
        run: echo "repository_lowercase=${GITHUB_REPOSITORY@L}" > $GITHUB_OUTPUT
  
  
      - name: Build and push bundle image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Containerfile.bundle
          push: true
          tags: |
            ghcr.io/${{ steps.repository_lowercase.outputs.repository_lowercase }}/bundle:${{ steps.version.outputs.VERSION }}
            ghcr.io/${{ steps.repository_lowercase.outputs.repository_lowercase }}/bundle:latest

      - name: Display published image URLs
        run: |
          echo "‚úÖ Bundle image published successfully!"
          echo ""
          echo "üìç Published to:"
          echo "   ghcr.io/${{ github.repository }}/bundle:${{ steps.version.outputs.VERSION }}"
          echo "   ghcr.io/${{ github.repository }}/bundle:latest"
          echo ""
          echo "üîó View package: https://github.com/${{ github.repository }}/pkgs/container/bundle"
