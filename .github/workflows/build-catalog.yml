name: Build and Publish Catalog Image (OLMv1)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to run workflow on'
        required: true
        default: 'main'

permissions:
  packages: write
  contents: read

jobs:
  build-catalog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up dependencies
        run: |
          # Install yq for YAML processing (required by make bundle)
          sudo wget -qO /usr/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/bin/yq

          # Install operator-sdk for bundle generation
          OPERATOR_SDK_VERSION=v1.41.0
          curl -LO https://github.com/operator-framework/operator-sdk/releases/download/${OPERATOR_SDK_VERSION}/operator-sdk_linux_amd64
          sudo mv operator-sdk_linux_amd64 /usr/local/bin/operator-sdk
          sudo chmod +x /usr/local/bin/operator-sdk

          # Install opm (Operator Package Manager) for FBC validation
          # Using v1.49.0 for better bundle rendering support (v1.35.0 has issues with schema detection)
          OPM_VERSION=v1.49.0
          curl -LO https://github.com/operator-framework/operator-registry/releases/download/${OPM_VERSION}/linux-amd64-opm
          sudo mv linux-amd64-opm /usr/local/bin/opm
          sudo chmod +x /usr/local/bin/opm
          opm version

      - name: Extract version from Makefile
        id: version
        run: |
          VERSION=$(grep "^CATALOG_TAG" Makefile | cut -d'=' -f2 | tr -d ' ')
          if [ -z "$VERSION" ]; then
            echo "‚ùå ERROR: Failed to extract VERSION from Makefile"
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "‚úÖ Extracted VERSION: $VERSION"

      - name: Generate bundle manifests
        run: |
          echo "üì¶ Generating bundle manifests with 'make bundle'..."
          make bundle
          if [ $? -ne 0 ]; then
            echo "‚ùå ERROR: 'make bundle' failed"
            exit 1
          fi
          echo "‚úÖ Bundle manifests generated successfully"

      - name: Generate FBC catalog metadata
        run: |
          echo "üìö Generating FBC catalog metadata with 'make catalog'..."
          make catalog
          if [ $? -ne 0 ]; then
            echo "‚ùå ERROR: 'make catalog' failed"
            exit 1
          fi
          echo "‚úÖ FBC catalog metadata generated successfully"

      - name: Validate File-Based Catalog structure
        run: |
          echo "üîç Validating File-Based Catalog (FBC) structure..."
          make catalog-validate
          if [ $? -ne 0 ]; then
            echo "‚ùå ERROR: FBC validation failed with 'make catalog-validate'"
            echo "Please ensure the catalog structure in catalog/ is valid"
            exit 1
          fi
          echo "‚úÖ FBC structure validated successfully"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set lowercase actor name
        id: actor_lowercase
        run: echo "actor_lowercase=${GITHUB_ACTOR@L}" >> $GITHUB_OUTPUT

      - name: Set lowercase repository name
        id: repository_lowercase
        run: echo "repository_lowercase=${GITHUB_REPOSITORY@L}" > $GITHUB_OUTPUT

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ steps.actor_lowercase.outputs.actor_lowercase }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push catalog image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Containerfile.catalog
          push: true
          tags: |
            ghcr.io/${{ steps.repository_lowercase.outputs.repository_lowercase }}/catalog:${{ steps.version.outputs.VERSION }}
            ghcr.io/${{ steps.repository_lowercase.outputs.repository_lowercase }}/catalog:latest

      - name: Display published image URLs
        run: |
          echo "‚úÖ Catalog image published successfully!"
          echo ""
          echo "üìç Published to:"
          echo "   ghcr.io/${{ github.repository }}/catalog:${{ steps.version.outputs.VERSION }}"
          echo "   ghcr.io/${{ github.repository }}/catalog:latest"
          echo ""
          echo "üîó View package: https://github.com/${{ github.repository }}/pkgs/container/catalog"
          echo ""
          echo "‚ú® This is an OLMv1 File-Based Catalog for modern OpenShift 4.19+ deployments."
