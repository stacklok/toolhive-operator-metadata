name: Build and Publish Index Image (OLMv0)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to run workflow on'
        required: true
        default: 'main'

permissions:
  packages: write
  contents: read

jobs:
  build-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up dependencies
        run: |
          # Install opm (Operator Package Manager) for index creation
          OPM_VERSION=v1.35.0
          curl -LO https://github.com/operator-framework/operator-registry/releases/download/${OPM_VERSION}/linux-amd64-opm
          sudo mv linux-amd64-opm /usr/local/bin/opm
          sudo chmod +x /usr/local/bin/opm
          opm version

      - name: Extract version from Makefile
        id: version
        run: |
          VERSION=$(grep "^INDEX_TAG" Makefile | cut -d'=' -f2 | tr -d ' ')
          BUNDLE_TAG=$(grep "^BUNDLE_TAG" Makefile | cut -d'=' -f2 | tr -d ' ')
          if [ -z "$VERSION" ]; then
            echo "‚ùå ERROR: Failed to extract VERSION from Makefile"
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "BUNDLE_TAG=$BUNDLE_TAG" >> $GITHUB_OUTPUT
          echo "‚úÖ Extracted VERSION: $VERSION"
          echo "‚úÖ Extracted BUNDLE_TAG: $BUNDLE_TAG"

      - name: Set lowercase actor name
        id: actor_lowercase
        run: echo "actor_lowercase=${GITHUB_ACTOR@L}" >> $GITHUB_OUTPUT

      - name: Set lowercase repository name
        id: repository_lowercase
        run: echo "repository_lowercase=${GITHUB_REPOSITORY@L}" > $GITHUB_OUTPUT
  
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ steps.actor_lowercase.outputs.actor_lowercase }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build OLMv0 index image
        run: |
          echo "üî® Building OLMv0 index image (SQLite-based, for legacy OpenShift 4.15-4.18)..."

          # Override image variables to use repository-based naming
          export BUNDLE_IMG="ghcr.io/${{ steps.repository_lowercase.outputs.repository_lowercase }}/bundle:${{ steps.version.outputs.BUNDLE_TAG }}"
          export INDEX_OLMV0_IMG="ghcr.io/${{ steps.repository_lowercase.outputs.repository_lowercase }}/index:${{ steps.version.outputs.VERSION }}"
          export BUNDLE_ORG=${{ steps.repository_lowercase.outputs.repository_lowercase }}
          export INDEX_ORG=${{ steps.repository_lowercase.outputs.repository_lowercase }}
          export CATALOG_ORG=${{ steps.repository_lowercase.outputs.repository_lowercase }}
          export OPERATOR_ORG=${{ steps.repository_lowercase.outputs.repository_lowercase }}
          export CONTAINER_TOOL=docker

          echo "  Bundle reference: $BUNDLE_IMG"
          echo "  Index target: $INDEX_OLMV0_IMG"

          make index-olmv0-build BUNDLE_IMG="$BUNDLE_IMG" INDEX_OLMV0_IMG="$INDEX_OLMV0_IMG"

          if [ $? -ne 0 ]; then
            echo "‚ùå ERROR: 'make index-olmv0-build' failed"
            echo "This may occur if the bundle image doesn't exist locally or remotely."
            echo "The Makefile uses --permissive flag to allow local images."
            exit 1
          fi
          echo "‚úÖ Index image built successfully"

      - name: Push index images
        run: |
          echo "Pushing index images..."

          # Push version tag
          docker push "ghcr.io/${{ steps.repository_lowercase.outputs.repository_lowercase }}/index:${{ steps.version.outputs.VERSION }}"

          # Push latest tag
          docker push "ghcr.io/${{ steps.repository_lowercase.outputs.repository_lowercase }}/index:latest"

          echo "‚úÖ Index images pushed successfully"

      - name: Display published image URLs
        run: |
          echo "‚úÖ Index image published successfully!"
          echo ""
          echo "üìç Published to:"
          echo "   ghcr.io/${{ steps.repository_lowercase.outputs.repository_lowercase }}/index:${{ steps.version.outputs.VERSION }}"
          echo "   ghcr.io/${{ steps.repository_lowercase.outputs.repository_lowercase }}/index:latest"
          echo ""
          echo "üîó View package: https://github.com/${{ github.repository }}/pkgs/container/index"
          echo ""
          echo "‚ö†Ô∏è  Note: This is an OLMv0 SQLite-based index for legacy OpenShift 4.15-4.18 compatibility."
