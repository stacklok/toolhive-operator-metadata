# Implementation Plan: Upgrade ToolHive Operator to v0.4.2

**Branch**: `012-upgrade-to-0` | **Date**: 2025-10-24 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/012-upgrade-to-0/spec.md`

**Note**: This plan generated by `/speckit.plan` command following the workflow defined in `.specify/templates/commands/plan.md`.

## Summary

This feature upgrades the ToolHive Operator Metadata project from v0.3.11 to v0.4.2, incorporating the new MCPGroup CRD and updating all version references, container images, and OLM bundle/catalog manifests. The upgrade follows a metadata-only approach using kustomize overlays and ensures all 6 CRDs (adding MCPGroup) are properly included in bundle and catalog artifacts with appropriate RBAC and CSV ownership declarations.

**Technical Approach**: Download v0.4.2 manifests from upstream (https://github.com/stacklok/toolhive/tree/v0.4.2), update all version tags and image references via kustomize replacements and direct file edits, integrate the new MCPGroup CRD into the existing 5-CRD collection, and rebuild/validate bundle and catalog using existing OLM tooling (opm, operator-sdk).

## Technical Context

**Language/Version**: YAML manifests, Makefile, Bash scripts
**Primary Dependencies**: kustomize 5.x, opm (Operator Package Manager), operator-sdk with go.kubebuilder.io/v4 plugin, yq, podman/docker
**Storage**: File-based (downloaded manifests in `downloaded/toolhive-operator/0.4.2/`, generated artifacts in `bundle/` and `catalog/`)
**Testing**: kustomize build validation, operator-sdk bundle validate, opm validate catalog, manual deployment verification to test cluster
**Target Platform**: OpenShift 4.15+ (primary via config/base), Kubernetes 1.25+ (secondary via config/default)
**Project Type**: Kubernetes operator metadata repository (no application code, pure manifests and build tooling)
**Performance Goals**: N/A (metadata-only project, no runtime performance requirements)
**Constraints**: MUST preserve kustomize build validity for both config/base and config/default; MUST NOT modify CRD content (constitution principle III); MUST maintain OpenShift compatibility
**Scale/Scope**: 6 CRDs total (5 existing + 1 new MCPGroup), ~20 YAML manifest files, 2 container image references

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Constitutional Alignment

**Principle I - Manifest Integrity**: ✅ COMPLIANT
All changes preserve kustomize build validity. Phase validation includes explicit `kustomize build config/base` and `kustomize build config/default` checks before completion.

**Principle II - Kustomize-Based Customization**: ✅ COMPLIANT
Version updates use kustomize replacements (`config/base/params.env` → container images). MCPGroup CRD added to kustomization resources list, not modified directly.

**Principle III - CRD Immutability**: ✅ COMPLIANT
All 6 CRDs (including new MCPGroup) downloaded verbatim from upstream v0.4.2 release without modification. Only kustomization.yaml updated to reference the new file.

**Principle IV - OpenShift Compatibility**: ✅ COMPLIANT
OpenShift-specific patches in `config/base` remain untouched. Version updates apply universally to both config/base and config/default via shared references.

**Principle V - Namespace Awareness**: ✅ COMPLIANT
No namespace changes required. Existing namespace patches (`opendatahub` for base, `toolhive-operator-system` for default) remain valid.

**Principle VI - OLM Multi-Bundle Support**: ✅ COMPLIANT
Catalog updated to reference v0.4.2 bundle while preserving structure supporting future multi-bundle catalogs (olm.package, olm.channel, olm.bundle schema).

**Operator SDK Plugin Policy**: ✅ COMPLIANT
All operator-sdk commands in Makefile explicitly specify `--plugins go.kubebuilder.io/v4` per constitutional requirement.

### Gate Status: ✅ PASSED

No constitutional violations. Proceed to Phase 0 research.

## Project Structure

### Documentation (this feature)

```
specs/012-upgrade-to-0/
├── spec.md              # Feature specification (input)
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (version delta analysis, CRD integration patterns)
├── data-model.md        # Phase 1 output (CRD entity relationships, version metadata)
├── quickstart.md        # Phase 1 output (upgrade procedure, validation steps)
└── contracts/           # Phase 1 output (not applicable - no API contracts for metadata project)
```

### Source Code (repository root)

This is a Kubernetes operator metadata repository with no application source code. Structure is manifest-centric:

```
config/
├── base/                # OpenShift overlay (opendatahub namespace)
│   ├── kustomization.yaml
│   ├── params.env       # Image version references (UPDATED: v0.4.2)
│   ├── openshift_env_var_patch.yaml
│   ├── openshift_res_utilization.yaml
│   └── openshift_sec_patches.yaml
├── default/             # Base Kubebuilder configuration (toolhive-operator-system namespace)
│   ├── kustomization.yaml
│   ├── manager_auth_proxy_patch.yaml
│   └── manager_config_patch.yaml
├── crd/                 # Custom Resource Definitions
│   ├── bases/
│   │   ├── toolhive.stacklok.dev_mcpexternalauthconfigs.yaml
│   │   ├── toolhive.stacklok.dev_mcpgroups.yaml  # NEW in v0.4.2
│   │   ├── toolhive.stacklok.dev_mcpregistries.yaml
│   │   ├── toolhive.stacklok.dev_mcpremoteproxies.yaml
│   │   ├── toolhive.stacklok.dev_mcpservers.yaml
│   │   └── toolhive.stacklok.dev_mcptoolconfigs.yaml
│   └── kustomization.yaml  # UPDATED: add mcpgroups reference
├── manager/
│   └── manager.yaml     # Deployment (UPDATED: v0.4.2 images)
├── rbac/
│   ├── role.yaml        # ClusterRole (UPDATED: add mcpgroups permissions)
│   └── ...
└── scorecard/
    └── config.yaml

downloaded/
└── toolhive-operator/
    ├── 0.3.11/          # Previous version (reference)
    │   ├── toolhive-operator.clusterserviceversion.yaml
    │   └── *.crd.yaml
    └── 0.4.2/           # NEW: v0.4.2 manifests from upstream
        ├── toolhive-operator.clusterserviceversion.yaml  # UPDATED metadata
        ├── mcpexternalauthconfigs.crd.yaml
        ├── mcpgroups.crd.yaml       # NEW CRD
        ├── mcpregistries.crd.yaml
        ├── mcpremoteproxies.crd.yaml
        ├── mcpservers.crd.yaml
        └── mcptoolconfigs.crd.yaml

bundle/                  # Generated OLM bundle (make bundle)
├── manifests/
│   ├── toolhive-operator.clusterserviceversion.yaml  # UPDATED: v0.4.2, 6 CRDs
│   └── *.crd.yaml       # 6 CRD files
├── metadata/
│   └── annotations.yaml
└── tests/scorecard/

catalog/                 # Generated FBC catalog (make catalog)
└── toolhive-operator/
    └── catalog.yaml     # UPDATED: v0.4.2 entry, 7 olm.bundle.object blobs

Makefile                 # Build orchestration (UPDATED: v0.4.2 version variables)
```

**Structure Decision**: This repository follows a **pure manifest repository** pattern (no application code). All changes are manifest updates, with key modifications concentrated in:
1. Version variables (`Makefile`, `config/base/params.env`)
2. CRD collection (`config/crd/bases/`, `config/crd/kustomization.yaml`)
3. RBAC permissions (`config/rbac/role.yaml`)
4. Downloaded upstream manifests (`downloaded/toolhive-operator/0.4.2/`)
5. Generated OLM artifacts (`bundle/`, `catalog/`)

## Complexity Tracking

*Fill ONLY if Constitution Check has violations that must be justified*

**Status**: No violations detected. Complexity tracking not required.

## Phase 0: Research & Discovery

**Goal**: Resolve all technical unknowns before design. Analyze v0.3.11 → v0.4.2 delta, MCPGroup CRD integration patterns, and validate upgrade path assumptions.

### Research Tasks

**R1 - Version Delta Analysis**
- **What**: Review git commit log between v0.3.11 and v0.4.2 tags in upstream repository
- **Why**: Identify breaking changes, API modifications, or structural changes beyond MCPGroup CRD addition
- **Method**: Clone https://github.com/stacklok/toolhive, checkout v0.4.2 tag, run `git log v0.3.11..v0.4.2 --oneline`, analyze commits for impacts to this metadata project
- **Output**: List of commits, classification (metadata impact / no impact), highlight any breaking changes or required migrations

**R2 - MCPGroup CRD Structure Analysis**
- **What**: Examine toolhive.stacklok.dev_mcpgroups.yaml structure, spec fields, status fields, validation rules
- **Why**: Understand how MCPGroup relates to existing CRDs (especially MCPServer), inform RBAC permission requirements, validate no special handling needed
- **Method**: Download CRD from https://raw.githubusercontent.com/stacklok/toolhive/v0.4.2/deploy/charts/operator-crds/crds/toolhive.stacklok.dev_mcpgroups.yaml, extract spec/status schemas, compare to MCPServer CRD patterns
- **Output**: Schema summary (key fields: spec.servers[], status.conditions[], etc.), relationship diagram (MCPGroup → MCPServer references)

**R3 - Existing CRD Integration Pattern Review**
- **What**: Analyze how MCPExternalAuthConfig, MCPRemoteProxy, MCPToolConfig were integrated in previous upgrades
- **Why**: Establish consistent pattern for adding MCPGroup (kustomization ordering, RBAC verb sets, CSV ownership format)
- **Method**: Review config/crd/kustomization.yaml, config/rbac/role.yaml, downloaded CSV files for existing 5 CRDs
- **Output**: Integration checklist (files to modify, sections to update, validation commands to run)

**R4 - CSV Patch Compatibility Verification**
- **What**: Verify OpenShift security patches (runAsUser removal, seccompProfile addition) apply cleanly to v0.4.2 CSV
- **Why**: Confirm existing yq-based patches in Makefile bundle target work without modification
- **Method**: Download v0.4.2 CSV, test-apply each yq patch from Makefile bundle target, verify no errors
- **Output**: Patch compatibility matrix (each patch → PASS/FAIL/NEEDS ADJUSTMENT)

**R5 - Image Availability Confirmation**
- **What**: Verify ghcr.io/stacklok/toolhive/operator:v0.4.2 and ghcr.io/stacklok/toolhive/proxyrunner:v0.4.2 exist and are pullable
- **Why**: Prevent deployment failures due to missing or inaccessible images
- **Method**: `podman pull ghcr.io/stacklok/toolhive/operator:v0.4.2` and `podman pull ghcr.io/stacklok/toolhive/proxyrunner:v0.4.2`
- **Output**: Image manifest inspection (creation date, layers, size), SHA256 digests

### Research Output: research.md

Create `/specs/012-upgrade-to-0/research.md` with structure:

```markdown
# Research: v0.3.11 → v0.4.2 Upgrade Analysis

## Decision: Upgrade to v0.4.2 with MCPGroup CRD

**Rationale**: [findings from R1 confirming no breaking changes]

**Alternatives Considered**: [stay on v0.3.11, skip to v0.5.x if available]

## R1: Version Delta Analysis

[Git log summary, commit highlights, impact assessment]

## R2: MCPGroup CRD Structure

[Schema documentation, field descriptions, relationship to MCPServer]

## R3: Integration Pattern

[Checklist derived from existing CRD integrations, file-by-file modification steps]

## R4: CSV Patch Compatibility

[Patch test results, any required adjustments to Makefile bundle target]

## R5: Image Availability

[Image pull confirmation, manifest details, digest references]

## Risks & Mitigations

[Identified risks from research, mitigation strategies]
```

**Gate**: Research complete when all NEEDS CLARIFICATION items resolved and research.md committed to feature branch.

## Phase 1: Design & Contracts

**Prerequisites**: Phase 0 research.md complete

### Design Artifacts

**D1 - Data Model** (`data-model.md`)

Document the entity model for v0.4.2 operator:

**Entities**:
- **MCPRegistry**: Registry of MCP server definitions (unchanged from v0.3.11)
- **MCPServer**: Individual server instance (unchanged from v0.3.11)
- **MCPGroup**: NEW - Logical grouping of MCPServers with unified status
- **MCPExternalAuthConfig**: External authentication configuration (unchanged)
- **MCPRemoteProxy**: Remote server proxy (unchanged)
- **MCPToolConfig**: Tool-specific configuration (unchanged)

**Relationships**:
- MCPGroup ⊃ MCPServer (one-to-many: group contains multiple servers)
- MCPServer → MCPRegistry (reference: server may reference registry definition)
- MCPServer → MCPExternalAuthConfig (reference: server may use auth config)
- MCPServer → MCPRemoteProxy (reference: server may use proxy)
- MCPServer → MCPToolConfig (reference: server may use tool config)

**Version Metadata**:
- **OperatorVersion**: Semantic version (v0.4.2)
- **ContainerImage**: Qualified image reference (registry/repo:tag)
- **BundleVersion**: OLM bundle version (0.4.2)
- **CatalogEntry**: Channel entry reference (toolhive-operator.v0.4.2)

**D2 - Quickstart** (`quickstart.md`)

Step-by-step upgrade procedure:

```markdown
# Quickstart: Upgrade to v0.4.2

## Prerequisites
- Git repository on branch `012-upgrade-to-0`
- Tools: kustomize, yq, podman, operator-sdk, opm

## Upgrade Steps

1. Download v0.4.2 manifests
2. Update Makefile version variables
3. Update config/base/params.env image tags
4. Update config/manager/manager.yaml image tags
5. Add MCPGroup CRD to config/crd/bases/
6. Update config/crd/kustomization.yaml
7. Update config/rbac/role.yaml with mcpgroups permissions
8. Update downloaded CSV with v0.4.2 metadata and MCPGroup ownership
9. Validate kustomize builds
10. Generate and validate bundle
11. Generate and validate catalog

## Validation Commands

[List of make targets and kubectl/oc commands to verify upgrade]

## Rollback Procedure

[Steps to revert to v0.3.11 if needed]
```

**D3 - Contracts** (`contracts/`)

**Not Applicable**: This is a metadata-only repository with no API contracts. CRD schemas are defined upstream and consumed verbatim. Skip contract generation.

**D4 - Agent Context Update**

Run `.specify/scripts/bash/update-agent-context.sh claude` to update Claude-specific context with:
- Technology: "Kubernetes Operator Metadata (ToolHive v0.4.2)"
- Tools: "kustomize, opm, operator-sdk (go.kubebuilder.io/v4), yq"
- Patterns: "Kustomize overlays, OLM bundle/catalog generation, CRD integration"

### Re-evaluate Constitution Check

**Post-Design Review**: ✅ PASSED

- Manifest Integrity: Design preserves both kustomize builds
- Kustomize-Based Customization: All changes use kustomize mechanisms or controlled file additions
- CRD Immutability: CRDs sourced from upstream without modification
- OpenShift Compatibility: No changes to OpenShift-specific patches
- Namespace Awareness: No namespace changes
- OLM Multi-Bundle Support: Catalog structure supports future multi-bundle scenarios
- Operator SDK Plugin: All commands specify required plugin

**Gate Status**: Ready for Phase 2 (tasks generation).

## Phase 2: Implementation Tasks

**Scope**: This phase is executed by `/speckit.tasks` command (NOT by `/speckit.plan`).

The `/speckit.tasks` command will generate a dependency-ordered task list in `tasks.md` based on:
- Functional requirements from spec.md
- Design artifacts from Phase 1 (data-model.md, quickstart.md)
- Constitutional compliance requirements

**Anticipated Task Categories**:
1. Download v0.4.2 manifests (foundational)
2. Update version references (parallel-safe after download)
3. Integrate MCPGroup CRD (dependent on download)
4. Update RBAC and CSV (dependent on CRD integration)
5. Build and validate artifacts (dependent on all updates)

## Success Metrics

**Phase 0 Complete When**:
- research.md exists with all 5 research tasks documented
- All NEEDS CLARIFICATION items resolved
- No open questions about v0.4.2 compatibility

**Phase 1 Complete When**:
- data-model.md documents all 6 CRDs and version metadata
- quickstart.md provides end-to-end upgrade procedure
- Agent context updated with v0.4.2 tooling
- Constitution re-check passes

**Implementation Ready When**:
- All Phase 0 and Phase 1 gates passed
- tasks.md generated by `/speckit.tasks` command
- Feature branch ready for implementation work

## Next Steps

**Current Status**: Plan generation complete.

**To Proceed**:
1. **Review this plan** - Confirm technical context, research tasks, and design approach align with expectations
2. **Execute Phase 0** - Run research tasks R1-R5, create research.md with findings
3. **Execute Phase 1** - Generate data-model.md, quickstart.md, update agent context
4. **Generate Tasks** - Run `/speckit.tasks` to create dependency-ordered task list
5. **Implement** - Run `/speckit.implement` to execute tasks from tasks.md

**Branch**: `012-upgrade-to-0`
**Plan File**: `/wip/src/github.com/RHEcosystemAppEng/toolhive-operator-metadata/specs/012-upgrade-to-0/plan.md`

---

**Plan Status**: ✅ COMPLETE | Phase 0 research tasks defined | Ready for research execution
